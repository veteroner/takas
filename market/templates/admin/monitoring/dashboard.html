{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}Sistem Monitoring Dashboard{% endblock %}

{% block extrahead %}
<style>
.monitoring-dashboard {
    margin: 20px;
}

.metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin: 20px 0;
}

.metric-card {
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.metric-card h3 {
    margin: 0 0 15px 0;
    color: #333;
    font-size: 18px;
}

.metric-value {
    font-size: 24px;
    font-weight: bold;
    color: #2e7d32;
    margin: 10px 0;
}

.metric-label {
    color: #666;
    font-size: 14px;
}

.health-status {
    display: flex;
    align-items: center;
    gap: 10px;
}

.status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
}

.status-healthy { background-color: #4caf50; }
.status-warning { background-color: #ff9800; }
.status-critical { background-color: #f44336; }

.action-buttons {
    margin: 20px 0;
}

.action-buttons button {
    margin: 5px;
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

.btn-primary { background-color: #2196f3; color: white; }
.btn-warning { background-color: #ff9800; color: white; }
.btn-danger { background-color: #f44336; color: white; }

.btn-primary:hover { background-color: #1976d2; }
.btn-warning:hover { background-color: #f57c00; }
.btn-danger:hover { background-color: #d32f2f; }

.log-section {
    margin-top: 30px;
    max-height: 400px;
    overflow-y: auto;
    background: #f5f5f5;
    padding: 15px;
    border-radius: 4px;
}

.log-entry {
    font-family: monospace;
    font-size: 12px;
    margin: 2px 0;
    padding: 2px 0;
    border-bottom: 1px solid #ddd;
}

.chart-container {
    height: 200px;
    margin: 15px 0;
}
</style>
{% endblock %}

{% block content %}
<div class="monitoring-dashboard">
    <h1>🏁 Sistem Monitoring Dashboard</h1>
    
    <div class="metrics-grid">
        <!-- System Metrics -->
        <div class="metric-card">
            <h3>🖥️ Sistem Durumu</h3>
            {% if system_stats.error %}
                <div class="health-status">
                    <span class="status-indicator status-warning"></span>
                    <span>{{ system_stats.message }}</span>
                </div>
            {% else %}
                <div class="metric-value">{{ system_stats.cpu_percent|floatformat:1 }}%</div>
                <div class="metric-label">CPU Kullanımı</div>
                
                <div class="metric-value">{{ system_stats.memory_percent|floatformat:1 }}%</div>
                <div class="metric-label">RAM Kullanımı</div>
                
                <div class="metric-value">{{ system_stats.disk_percent|floatformat:1 }}%</div>
                <div class="metric-label">Disk Kullanımı</div>
            {% endif %}
        </div>

        <!-- Health Status -->
        <div class="metric-card">
            <h3>❤️ Sağlık Durumu</h3>
            {% for check_name, status in health_status.items %}
                <div class="health-status">
                    <span class="status-indicator status-{% if status.status == 'healthy' %}healthy{% elif status.status == 'warning' %}warning{% else %}critical{% endif %}"></span>
                    <span>{{ check_name }}: {{ status.message }}</span>
                </div>
            {% endfor %}
        </div>

        <!-- Error Summary -->
        <div class="metric-card">
            <h3>⚠️ Hata Özeti</h3>
            <div class="metric-value">{{ error_summary.total_errors|default:0 }}</div>
            <div class="metric-label">Toplam Hata (24h)</div>
            
            <div class="metric-value">{{ error_summary.critical_errors|default:0 }}</div>
            <div class="metric-label">Kritik Hatalar</div>
            
            <div class="metric-value">{{ error_summary.recent_errors|default:0 }}</div>
            <div class="metric-label">Son 1 Saatte</div>
        </div>

        <!-- Performance -->
        <div class="metric-card">
            <h3>⚡ Performans</h3>
            <div class="metric-value">{{ system_stats.response_time|default:"N/A" }}</div>
            <div class="metric-label">Ortalama Yanıt Süresi</div>
            
            <div class="metric-value">{{ system_stats.active_users|default:0 }}</div>
            <div class="metric-label">Aktif Kullanıcılar</div>
            
            <div class="metric-value">{{ system_stats.requests_per_minute|default:0 }}</div>
            <div class="metric-label">Dakikalık İstek</div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons">
        <button class="btn-primary" onclick="refreshMetrics()">🔄 Metrikleri Yenile</button>
        <button class="btn-warning" onclick="clearCache()">🧹 Cache Temizle</button>
        <button class="btn-danger" onclick="resetMetrics()">♻️ Metrikleri Sıfırla</button>
    </div>

    <!-- Real-time Charts Placeholder -->
    <div class="metric-card">
        <h3>📊 Gerçek Zamanlı Grafikler</h3>
        <div id="cpu-chart" class="chart-container">
            <p style="text-align: center; margin-top: 80px; color: #999;">
                CPU kullanımı grafiği buraya gelecek
            </p>
        </div>
        <div id="memory-chart" class="chart-container">
            <p style="text-align: center; margin-top: 80px; color: #999;">
                Bellek kullanımı grafiği buraya gelecek
            </p>
        </div>
    </div>

    <!-- Recent Logs -->
    <div class="metric-card">
        <h3>📝 Son Loglar</h3>
        <div class="log-section" id="recent-logs">
            <div class="log-entry">[INFO] Monitoring dashboard loaded successfully</div>
            <div class="log-entry">[INFO] System health check completed</div>
            <div class="log-entry">[INFO] Performance metrics updated</div>
        </div>
    </div>
</div>

<script>
// Auto-refresh every 30 seconds
let autoRefreshInterval;

function startAutoRefresh() {
    autoRefreshInterval = setInterval(refreshMetrics, 30000);
}

function stopAutoRefresh() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
    }
}

function refreshMetrics() {
    fetch('{% url "market:system_metrics_api" %}')
        .then(response => response.json())
        .then(data => {
            console.log('Metrics updated:', data);
            // Update UI with new data
        })
        .catch(error => console.error('Error fetching metrics:', error));
}

function clearCache() {
    if (confirm('Cache temizlensin mi?')) {
        fetch('{% url "market:clear_cache_api" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message || 'Cache temizlendi');
            refreshMetrics();
        })
        .catch(error => console.error('Error clearing cache:', error));
    }
}

function resetMetrics() {
    if (confirm('Tüm performans metrikleri sıfırlansın mı?')) {
        fetch('{% url "market:reset_metrics_api" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message || 'Metrikler sıfırlandı');
            refreshMetrics();
        })
        .catch(error => console.error('Error resetting metrics:', error));
    }
}

// Start auto-refresh on page load
document.addEventListener('DOMContentLoaded', function() {
    startAutoRefresh();
    refreshMetrics();
});

// Stop auto-refresh when page is hidden
document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
        stopAutoRefresh();
    } else {
        startAutoRefresh();
    }
});
</script>
{% endblock %}