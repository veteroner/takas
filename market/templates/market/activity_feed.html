{% extends "market/base.html" %}
{% load static %}

{% block title %}📊 Canlı Aktiviteler - Swapzy{% endblock %}

{% block content %}
<div class="container">
    <div class="hero">
        <h1>📊 Canlı Aktivite Feed'i</h1>
        <p>Platformdaki anlık aktiviteleri takip edin</p>
        <div class="stats">
            <div class="stat">
                <span class="number" id="online-count">...</span>
                <span class="label">Online Kullanıcı</span>
            </div>
            <div class="stat">
                <span class="number">{{ activities.count }}</span>
                <span class="label">Son Aktivite</span>
            </div>
        </div>
    </div>

    <div style="display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap;">
        <button onclick="startLiveFeed()" class="btn" id="live-feed-btn">
            🔴 Canlı Feed Başlat
        </button>
        <button onclick="stopLiveFeed()" class="btn outline" id="stop-feed-btn" style="display: none;">
            ⏹️ Durdur
        </button>
        <a href="{% url 'market:online_users' %}" class="btn outline">
            👥 Online Kullanıcılar
        </a>
        <button onclick="refreshFeed()" class="btn outline">
            🔄 Yenile
        </button>
    </div>

    <div class="activity-feed-container">
        <div id="activity-feed">
            {% for activity in activities %}
            <div class="activity-item" data-activity-id="{{ activity.id }}">
                <div class="activity-icon">
                    {% if activity.activity_type == 'item_created' %}🆕
                    {% elif activity.activity_type == 'trade_created' %}🔄
                    {% elif activity.activity_type == 'trade_completed' %}✅
                    {% elif activity.activity_type == 'user_joined' %}👋
                    {% elif activity.activity_type == 'item_favorited' %}❤️
                    {% elif activity.activity_type == 'recommendation_clicked' %}🎯
                    {% elif activity.activity_type == 'user_online' %}🟢
                    {% else %}📢
                    {% endif %}
                </div>
                
                <div class="activity-content">
                    <div class="activity-description">{{ activity.description }}</div>
                    <div class="activity-meta">
                        <span class="activity-user">{{ activity.user.first_name|default:activity.user.username }}</span>
                        <span class="activity-time">{{ activity.created_at|timesince }} önce</span>
                        <span class="activity-type">{{ activity.get_activity_type_display }}</span>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="empty-state">
                <h3>📪 Henüz aktivite yok</h3>
                <p>Platform aktiviteleri burada görünecek!</p>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<style>
.activity-feed-container {
    max-width: 800px;
    margin: 0 auto;
    position: relative;
}

.activity-item {
    background: white;
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    display: flex;
    align-items: flex-start;
    gap: 12px;
    transition: all 0.3s ease;
    border-left: 4px solid transparent;
}

.activity-item.new {
    border-left-color: #48bb78;
    background: linear-gradient(135deg, #f0fff4, #ffffff);
    animation: slideIn 0.5s ease;
}

.activity-item:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

@keyframes slideIn {
    from {
        transform: translateY(-20px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

.activity-icon {
    font-size: 20px;
    flex-shrink: 0;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(102, 126, 234, 0.1);
    border-radius: 50%;
}

.activity-content {
    flex: 1;
}

.activity-description {
    font-weight: 500;
    color: #2d3748;
    margin-bottom: 6px;
    line-height: 1.4;
}

.activity-meta {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 14px;
    color: #718096;
    flex-wrap: wrap;
}

.activity-user {
    font-weight: 500;
    color: #667eea;
}

.activity-type {
    background: rgba(102, 126, 234, 0.1);
    color: #667eea;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 12px;
}

.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #718096;
}

.empty-state h3 {
    margin-bottom: 12px;
    font-size: 24px;
}

.live-indicator {
    position: fixed;
    top: 20px;
    right: 20px;
    background: #48bb78;
    color: white;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: 600;
    box-shadow: 0 4px 12px rgba(72, 187, 120, 0.3);
    z-index: 1000;
    display: none;
}

.live-indicator.active {
    display: block;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

@media (max-width: 768px) {
    .activity-meta {
        flex-direction: column;
        align-items: flex-start;
        gap: 4px;
    }
    
    .live-indicator {
        top: 10px;
        right: 10px;
        font-size: 12px;
        padding: 6px 12px;
    }
}
</style>

<div class="live-indicator" id="live-indicator">
    🔴 CANLI FEED AKTİF
</div>

<script>
let liveFeedActive = false;

function startLiveFeed() {
    if (typeof realtimeService !== 'undefined') {
        realtimeService.startActivityFeed();
        liveFeedActive = true;
        
        document.getElementById('live-feed-btn').style.display = 'none';
        document.getElementById('stop-feed-btn').style.display = 'inline-block';
        document.getElementById('live-indicator').classList.add('active');
        
        // Update online count
        updateOnlineCount();
        
        // Auto-update online count every 30 seconds
        setInterval(updateOnlineCount, 30000);
        
        console.log('📊 Canlı aktivite feed\'i başlatıldı');
    } else {
        alert('Real-time servis henüz yüklenmedi. Sayfayı yenileyin.');
    }
}

function stopLiveFeed() {
    if (typeof realtimeService !== 'undefined' && realtimeService.activitySocket) {
        realtimeService.activitySocket.close();
        liveFeedActive = false;
        
        document.getElementById('live-feed-btn').style.display = 'inline-block';
        document.getElementById('stop-feed-btn').style.display = 'none';
        document.getElementById('live-indicator').classList.remove('active');
        
        console.log('📊 Canlı aktivite feed\'i durduruldu');
    }
}

function updateOnlineCount() {
    fetch('/online-users/')
        .then(response => response.text())
        .then(html => {
            // Extract count from response (quick and dirty)
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const countElement = doc.querySelector('.stat .number');
            if (countElement) {
                document.getElementById('online-count').textContent = countElement.textContent;
            }
        })
        .catch(error => {
            console.error('Online count update error:', error);
        });
}

function refreshFeed() {
    window.location.reload();
}

// Auto-start live feed when page loads
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        if (typeof realtimeService !== 'undefined') {
            startLiveFeed();
        }
    }, 1000);
});

// Override the displayLiveActivity function to add to our feed
if (typeof realtimeService !== 'undefined') {
    const originalDisplayLiveActivity = realtimeService.displayLiveActivity;
    realtimeService.displayLiveActivity = function(activity) {
        // Call original function
        originalDisplayLiveActivity.call(this, activity);
        
        // Also add to our custom feed if we're on this page
        if (liveFeedActive) {
            addActivityToFeed(activity);
        }
    };
}

function addActivityToFeed(activity) {
    const feedContainer = document.getElementById('activity-feed');
    if (!feedContainer) return;
    
    // Check if this is an empty state
    const emptyState = feedContainer.querySelector('.empty-state');
    if (emptyState) {
        emptyState.remove();
    }
    
    const activityElement = document.createElement('div');
    activityElement.className = 'activity-item new';
    activityElement.dataset.activityId = activity.id;
    
    // Get activity type icon
    const typeIcons = {
        'item_created': '🆕',
        'trade_created': '🔄',
        'trade_completed': '✅',
        'user_joined': '👋',
        'item_favorited': '❤️',
        'recommendation_clicked': '🎯',
        'user_online': '🟢'
    };
    
    const icon = typeIcons[activity.activity_type] || '📢';
    
    activityElement.innerHTML = `
        <div class="activity-icon">${icon}</div>
        <div class="activity-content">
            <div class="activity-description">${activity.description}</div>
            <div class="activity-meta">
                <span class="activity-user">${activity.user_display || activity.user}</span>
                <span class="activity-time">Az önce</span>
                <span class="activity-type">${activity.activity_type}</span>
            </div>
        </div>
    `;
    
    // Add to top of feed
    feedContainer.insertBefore(activityElement, feedContainer.firstChild);
    
    // Remove old activities (keep only 100)
    const activities = feedContainer.querySelectorAll('.activity-item');
    if (activities.length > 100) {
        activities[activities.length - 1].remove();
    }
    
    // Remove 'new' class after animation
    setTimeout(() => {
        activityElement.classList.remove('new');
    }, 5000);
}
</script>

{% endblock %}
