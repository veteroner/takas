{% extends "market/base.html" %}
{% load static %}

{% block title %}üîî Bildirimlerim - Swapzy{% endblock %}

{% block content %}
<div class="container">
    <div class="hero">
        <h1>üîî Bildirimlerim</h1>
        <p>Ger√ßek zamanlƒ± bildirimleriniz ve g√ºncellemeleriniz</p>
        <div class="stats">
            <div class="stat">
                <span class="number">{{ notifications.count }}</span>
                <span class="label">Toplam Bildirim</span>
            </div>
            <div class="stat">
                <span class="number">{{ unread_count }}</span>
                <span class="label">Okunmamƒ±≈ü</span>
            </div>
        </div>
    </div>

    <div style="display: flex; gap: 20px; margin-bottom: 20px;">
        <button onclick="markAllAsRead()" class="btn">
            ‚úÖ T√ºm√ºn√º Okundu ƒ∞≈üaretle
        </button>
        <button onclick="testNotification()" class="btn outline">
            üß™ Test Bildirimi
        </button>
        <button onclick="refreshNotifications()" class="btn outline">
            üîÑ Yenile
        </button>
    </div>

    <div class="notifications-container">
        {% for notification in notifications %}
        <div class="notification-item {% if not notification.is_read %}unread{% endif %}" 
             data-notification-id="{{ notification.id }}">
            <div class="notification-icon">
                {% if notification.notification_type == 'trade_request' %}üîÑ
                {% elif notification.notification_type == 'trade_accepted' %}‚úÖ
                {% elif notification.notification_type == 'trade_rejected' %}‚ùå
                {% elif notification.notification_type == 'new_message' %}üí¨
                {% elif notification.notification_type == 'item_liked' %}‚ù§Ô∏è
                {% elif notification.notification_type == 'new_recommendation' %}üéØ
                {% elif notification.notification_type == 'system_update' %}üîî
                {% elif notification.notification_type == 'trade_reminder' %}‚è∞
                {% elif notification.notification_type == 'profile_view' %}üëÅÔ∏è
                {% else %}üì¢
                {% endif %}
            </div>
            
            <div class="notification-content">
                <div class="notification-title">{{ notification.title }}</div>
                <div class="notification-message">{{ notification.message }}</div>
                <div class="notification-meta">
                    <span class="notification-time">{{ notification.time_since_created }}</span>
                    {% if notification.sender %}
                        <span class="notification-sender">{{ notification.sender.first_name|default:notification.sender.username }}</span>
                    {% endif %}
                    {% if not notification.is_read %}
                        <span class="unread-badge">Yeni</span>
                    {% endif %}
                </div>
            </div>

            <div class="notification-actions">
                {% if notification.action_url %}
                    <a href="{{ notification.action_url }}" class="btn-small">Git</a>
                {% endif %}
                {% if not notification.is_read %}
                    <button onclick="markAsRead({{ notification.id }})" class="btn-small outline">
                        ‚úì Okundu
                    </button>
                {% endif %}
            </div>
        </div>
        {% empty %}
        <div class="empty-state">
            <h3>üì™ Hen√ºz bildiriminiz yok</h3>
            <p>Yeni aktiviteler olduƒüunda burada g√∂r√ºnecek!</p>
        </div>
        {% endfor %}
    </div>
</div>

<style>
.notifications-container {
    max-width: 800px;
    margin: 0 auto;
}

.notification-item {
    background: white;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 15px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    display: flex;
    align-items: flex-start;
    gap: 15px;
    transition: all 0.3s ease;
    position: relative;
}

.notification-item.unread {
    border-left: 4px solid #667eea;
    background: linear-gradient(135deg, #f8f9ff, #ffffff);
}

.notification-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(0,0,0,0.15);
}

.notification-icon {
    font-size: 24px;
    flex-shrink: 0;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(102, 126, 234, 0.1);
    border-radius: 50%;
}

.notification-content {
    flex: 1;
}

.notification-title {
    font-weight: 600;
    font-size: 16px;
    color: #2d3748;
    margin-bottom: 8px;
}

.notification-message {
    color: #4a5568;
    line-height: 1.5;
    margin-bottom: 8px;
}

.notification-meta {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 14px;
    color: #718096;
}

.unread-badge {
    background: #e53e3e;
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
}

.notification-actions {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.btn-small {
    padding: 6px 12px;
    font-size: 14px;
    border-radius: 6px;
    text-decoration: none;
    text-align: center;
    background: #667eea;
    color: white;
    border: none;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-small:hover {
    background: #5a6fd8;
}

.btn-small.outline {
    background: transparent;
    color: #667eea;
    border: 1px solid #667eea;
}

.btn-small.outline:hover {
    background: #667eea;
    color: white;
}

.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #718096;
}

.empty-state h3 {
    margin-bottom: 12px;
    font-size: 24px;
}

@media (max-width: 768px) {
    .notification-item {
        flex-direction: column;
        gap: 12px;
    }
    
    .notification-actions {
        flex-direction: row;
        width: 100%;
        justify-content: flex-end;
    }
}
</style>

<script>
function markAsRead(notificationId) {
    fetch(`/api/notification/read/${notificationId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Visual feedback
            const notificationElement = document.querySelector(`[data-notification-id="${notificationId}"]`);
            if (notificationElement) {
                notificationElement.classList.remove('unread');
                const badge = notificationElement.querySelector('.unread-badge');
                if (badge) badge.remove();
                const button = notificationElement.querySelector('button[onclick*="markAsRead"]');
                if (button) button.remove();
            }
            
            // Update global counter
            realtimeService.updateNotificationCounter();
        } else {
            alert('Hata: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Bir hata olu≈ütu');
    });
}

function markAllAsRead() {
    if (!confirm('T√ºm bildirimleri okundu olarak i≈üaretlemek istediƒüinizden emin misiniz?')) {
        return;
    }
    
    fetch('/api/notifications/read-all/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Remove all unread classes and badges
            document.querySelectorAll('.notification-item.unread').forEach(item => {
                item.classList.remove('unread');
                const badge = item.querySelector('.unread-badge');
                if (badge) badge.remove();
                const button = item.querySelector('button[onclick*="markAsRead"]');
                if (button) button.remove();
            });
            
            // Update counters
            realtimeService.updateNotificationCounter();
            alert(data.message);
        } else {
            alert('Hata: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Bir hata olu≈ütu');
    });
}

function testNotification() {
    const title = prompt('Bildirim ba≈ülƒ±ƒüƒ±:', 'üß™ Test Bildirimi');
    const message = prompt('Bildirim mesajƒ±:', 'Bu bir test bildirimidir!');
    
    if (!title || !message) return;
    
    fetch('/api/test-notification/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            title: title,
            message: message
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Test bildirimi g√∂nderildi! Real-time bildirim olarak g√∂rmelisiniz.');
        } else {
            alert('Hata: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Bir hata olu≈ütu');
    });
}

function refreshNotifications() {
    window.location.reload();
}
</script>

{% endblock %}
